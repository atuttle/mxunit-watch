#!/usr/bin/env node

var program = require('commander');
var mxunit = require('../mxunit');
var watchr = require('watchr');
var pkg = require('../package.json');

program
	.version(pkg.version)
	.option('-H, --host [hostname]', 'Hostname where your tests are web-accessible')
	.option('-d, --dir [directory]', 'Directory of files to watch')
	.option('-l, --list [url]', 'URL of tests listing')
	.option('--debug', 'Show debug output')
	.parse(process.argv);

if (!program.list){
	console.log('ERROR: --list is required');
	process.exit(1);
}else{
	mxunit.loadList(program.list, function(loaded){
		if (!loaded){
			console.log('Unable to load the tests list. Did you enter the correct URL? (' + program.list + ')');
		}
	});
}

program.dir = program.dir || __dirname;
program.host = program.host || 'localhost';

if (program.debug){
	console.log('DEBUG: Watching folder: %s', program.dir);
	console.log('DEBUG: Tests will use hostname: %s', program.host);
}

watchr.watch({
	paths: [program.dir]
	,listeners: {
		change: function(changeType, filePath, fileCurrentStat, filePrevStat){
			var ext = filePath.slice(-4);
			if (ext === '.cfm' || ext === '.cfc' || ext === '.xml'){
				mxunit.loadList(program.list, function(loaded){
					if (loaded){
						mxunit.runAll(program.host, function(){});
					}else{
						console.log('ERROR: Unable to load tests list. Did you enter the correct URL? (' + program.list + ')');
					}
				});
			}
		}
		,error: function(err){
			console.log('An error occured:', err);
		}
	}
	,next: function(err,watchers){
		if (err) {
			return console.log("Watching files failed with error", err);
		}
		console.log('Watching for file changes. Get coding!')
	}
});
